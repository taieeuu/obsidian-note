---
Date: 2024-02-07
tags:
  - 資安
---
## Protection

網站由客戶端和服務器端代碼組合而成。客戶端代碼是由瀏覽器呈現並在瀏覽器中執行的 HTML 和 JavaScript。這允許用戶導航到您站點上的其他 URL，向服務器提交 HTML 表單，並通過 JavaScript 觸發 AJAX 請求。您的服務器端代碼將攔截 HTTP 請求中發送的數據，並對其採取適當的行動。

這些服務器端操作也可以由偽造的 HTTP 請求觸發，除非您明確採取保護措施。當惡意行為者誘騙受害者點擊鏈接或運行某些代碼，從而觸發偽造請求時，就會發生 CSRF 攻擊。（這種惡意代碼通常託管在攻擊者擁有的網站上，在另一個域上——因此稱為“跨域”。）

防止 CSRF（通常發音為“sea-surf”）需要兩件事：確保 GET 請求沒有副作用，並確保非 GET 請求只能來自您的客戶端代碼。

- Reset  
    Representation State Transfer (REST)是一系列設計原則，將某些類型的操作（查看、創建、刪除、更新）分配給不同的HTTP 動詞。遵循 REST-ful 設計將使您的代碼保持整潔並幫助您的站點擴展。此外，REST 堅持 GET 請求僅用於查看資源。讓您的 GET 請求沒有副作用將限制惡意製作的 URL 可能造成的危害——攻擊者將不得不更加努力地工作以生成有害的 POST 請求。
    
- 防偽令牌  
    即使編輯操作僅限於非 GET 請求，您也不會完全受到保護。POST 請求仍然可以從其他域上託管的腳本和頁面發送到您的站點。為了確保您只處理有效的 HTTP 請求，您需要在每個 HTTP 響應中包含一個秘密且唯一的令牌，並讓服務器在使用 POST 方法（或任何其他方法）的後續請求中傳回該令牌時驗證該令牌事實上，除了 GET。）
    
    這稱為防偽令牌。每次您的服務器呈現執行敏感操作的頁面時，它都應該在隱藏的 HTML 表單字段中寫出一個防偽標記。此令牌必須包含在表單提交或 AJAX 調用中。服務器應在後續請求中返回令牌時驗證令牌，並拒絕任何缺少或無效令牌的調用。
    
    防偽令牌通常是（強）隨機數，在寫入隱藏字段時存儲在 cookie 或服務器上。服務器會將入站請求附加的令牌與存儲在 cookie 中的值進行比較。如果值相同，服務器將接受有效的 HTTP 請求。
    
    大多數現代框架都包含使添加防偽令牌變得相當簡單的功能。請參閱下面的代碼示例。
    
- 確保使用 SameSite Cookie 屬性發送 Cookie  
    Google Chrome 團隊在Set-Cookie標頭中添加了一個新屬性以幫助防止 CSRF，並很快得到其他瀏覽器供應商的支持。cookie 屬性允許開發者指示瀏覽器Same-Site控制 cookie 是否隨第三方域發起的請求一起發送。
    
    為 cookie 設置 Same-Site 屬性非常簡單：
    
    Set-Cookie: CookieName=CookieValue; SameSite=Lax;  
    Set-Cookie: CookieName=CookieValue; SameSite=Strict;  
    值Strict將意味著第三方域向您的域發起的任何請求都將被瀏覽器剝離任何 cookie。這是最安 全的設置，因為它可以防止惡意站點試圖在用戶會話下執行有害操作。
    
    值Lax允許從第三方域到您的 域的 GET 請求附加 cookie - 但僅限GET 請求。使用此設置， 如果用戶點擊來自其他網站（例如 Google 搜索結果）的鏈接，則無需再次登錄您的網​​站。這會 帶來更友好的用戶體驗 - 但請確保您的 GET 請求沒有副作用！
    
- 包括敏感操作的附加身份驗證  
    許多站點需要輔助身份驗證步驟，或者在用戶執行敏感操作時需要重新確認登錄詳細信息。（想想一個典型的密碼重置頁面——通常用戶在設置新密碼之前必須指定他們的舊密碼。）這不僅可以保護可能不小心讓自己登錄到可公開訪問的計算機上的用戶，而且還可以大大減少CSRF 攻擊的可能性。
    

## 代碼示例

### Python

要在 Django 中啟用 CSRF 保護， 請適當配置您的中間件 。然後按以下方式將防偽標記添加到您的 HTML 表單中：

```
<form action="." method="post">
  {% csrf_token %}
</form>  
```  

### Node

[express/csurf](https://github.com/expressjs/csurf)庫為 Express 實現了 CSRF 保護。

### PHP

[OWASP](https://wiki.owasp.org/index.php/PHP_CSRF_Guard)有關於如何在 PHP 中實現 CSRF 保護的說明。
